import{Observable as t,fromEvent as e}from"rxjs";const n=/:[^/]+/g,o=/^\/(?=[^?]*)/,r=/\[/,c=/([^[]+)\[([^[]*)\]/,a=/\[([^[]*)\]/,s=/[^[]+/,i=["localhost","0.0.0.0","127.0.0.1",null],u=Array.isArray;function l(t){return"string"==typeof t?t.trim():""}function h(t){return t=l(`${t}`),!(["null","undefined",""].indexOf(t)>-1)&&!isNaN(+t)}function p(t){return t&&"object"==typeof t}function f(t){return p(t)&&!u(t)}function _(t){return"string"==typeof t&&o.test(t)}function d(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function x(t,e){if(t&&t.length)for(let n=0;n<t.length;n+=1)if("function"==typeof e){const o=e.apply(t,[t[n],n]);if("boolean"==typeof o){if(o)continue;break}}}function b(t,e){p(t)&&Object.keys(t).forEach((function(n){e[n]=t[n]}))}function v(){const t=p(arguments[0])?arguments[0]:{};for(let e=1;e<arguments.length;e++)b(arguments[e],t);return t}if(void 0===window.CustomEvent){const t=function(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};const n=document.createEvent("CustomEvent");return n.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),n};t.prototype=window.Event.prototype,window.CustomEvent=t}function g(t,e,n){t instanceof Node&&(t=[t]),function(t){return t instanceof NodeList||t instanceof HTMLCollection||Array.isArray(t)}(t)&&"string"==typeof e&&x(t,t=>{const o=new window.CustomEvent(e,{bubbles:!0,cancelable:!0,detail:n||[]});t.dispatchEvent(o)})}const w=window.location,y=String.fromCharCode;function m(t,e,n){t.context_data_position==e-1?(t.context_data_position=0,t.context_data.push(n(t.context_data_val)),t.context_data_val=0):t.context_data_position++}function S(t){t.context_enlargeIn--,0==t.context_enlargeIn&&(t.context_enlargeIn=2**t.context_numBits,t.context_numBits++)}function C(t,e,n){if(d(t.context_dictionaryToCreate,t.context_w)){if(t.context_w.charCodeAt(0)<256){for(let o=0;o<t.context_numBits;o++)t.context_data_val=t.context_data_val<<1,m(t,e,n);t.value=t.context_w.charCodeAt(0);for(let o=0;o<8;o++)t.context_data_val=t.context_data_val<<1|1&t.value,m(t,e,n),t.value=t.value>>1}else{t.value=1;for(let o=0;o<t.context_numBits;o++)t.context_data_val=t.context_data_val<<1|t.value,m(t,e,n),t.value=0;t.value=t.context_w.charCodeAt(0);for(let o=0;o<16;o++)t.context_data_val=t.context_data_val<<1|1&t.value,m(t,e,n),t.value=t.value>>1}S(t),delete t.context_dictionaryToCreate[t.context_w]}else{t.value=t.context_dictionary[t.context_w];for(let o=0;o<t.context_numBits;o++)t.context_data_val=t.context_data_val<<1|1&t.value,m(t,e,n),t.value=t.value>>1}S(t)}function E(t,e,n,o){let r=0,c=1;for(;c!==e;){const e=t.val&t.position;t.position>>=1,0===t.position&&(t.position=n,t.val=o(t.index++)),r|=(e>0?1:0)*c,c<<=1}return r}function $(t){return null==t?"":function(t,e,n){if(null==t)return"";const o={context_dictionary:{},context_dictionaryToCreate:{},context_data:[],context_c:"",context_wc:"",context_w:"",context_enlargeIn:2,context_dictSize:3,context_numBits:2,context_data_val:0,context_data_position:0};let r=0;for(let r=0;r<t.length;r+=1)o.context_c=t.charAt(r),d(o.context_dictionary,o.context_c)||(o.context_dictionary[o.context_c]=o.context_dictSize++,o.context_dictionaryToCreate[o.context_c]=!0),o.context_wc=o.context_w+o.context_c,d(o.context_dictionary,o.context_wc)?o.context_w=o.context_wc:(C(o,e,n),o.context_dictionary[o.context_wc]=o.context_dictSize++,o.context_w=String(o.context_c));for(""!==o.context_w&&C(o,e,n),o.value=2,r=0;r<o.context_numBits;r++)o.context_data_val=o.context_data_val<<1|1&o.value,m(o,e,n),o.value=o.value>>1;for(;;){if(o.context_data_val=o.context_data_val<<1,o.context_data_position==e-1){o.context_data.push(n(o.context_data_val));break}o.context_data_position++}return o.context_data.join("")}(t,15,t=>y(t+32))+" "}function O(t){return null==t?"":""===t?null:function(t,e,n){const o=[],r={val:n(0),position:e,index:1},c=[];let a,s,i=4,u=4,l=3,h="";for(let t=0;t<3;t++)o[t]=t;switch(E(r,Math.pow(2,2),e,n)){case 0:s=y(E(r,Math.pow(2,8),e,n));break;case 1:s=y(E(r,Math.pow(2,16),e,n));break;case 2:return""}for(o[3]=s,a=s,c.push(s);;){if(r.index>t)return"";switch(s=E(r,Math.pow(2,l),e,n)){case 0:o[u++]=y(E(r,Math.pow(2,8),e,n)),s=u-1,i--;break;case 1:o[u++]=y(E(r,Math.pow(2,16),e,n)),s=u-1,i--;break;case 2:return c.join("")}if(0===i&&(i=Math.pow(2,l),l++),o[s])h=o[s];else{if(s!==u)return null;h=a+a.charAt(0)}c.push(h),o[u++]=a+h.charAt(0),i--,a=h,0===i&&(i=Math.pow(2,l),l++)}}(t.length,16384,e=>t.charCodeAt(e)-32)}function j(){try{return sessionStorage.setItem("testKey","testValue"),sessionStorage.removeItem("testKey"),!0}catch(t){return!1}}function k(t,e){return j()?sessionStorage.setItem(t,$(p(e)?JSON.stringify(e):e)):function(t,e){if(t&&void 0!==e){const n=w.hostname,o="https:"===w.protocol;let r=e;p(e)&&(r=JSON.stringify(e));const c="; path=/",a=-1===i.indexOf(n)?`; domain=${l(n)}`:"",s=o?"; secure":"";document.cookie=`${t} = ${r}${a}${c}${s}`}}(t,e)}function I(t){if(j()){let e=O(sessionStorage.getItem(t));try{return e=JSON.parse(e),e}catch(t){return e}}return function(t){if(t){const e=decodeURIComponent(document.cookie);let n="";return x(e.split(";"),e=>{const o=`${t}=`,r=e.indexOf(o);if(r>-1)return n=l(e.substring(r+o.length,e.length)),!1}),n}return""}(t)}const R={set(){return k.apply(this,arguments)},get(){return I.apply(this,arguments)}};const A=new class{getDataFromStore(t){return v(R.get("routeStore"))[t]}setDataToStore(t,e){let n=v(R.get("routeStore"));return!(n[t]&&(!e||f(e)&&0===Object.keys(e).length))&&R.set("routeStore",v({},n,{[t]:e}))}};class N{constructor(t,e,n){const{location:o,preservePath:r}=e.config,[c,a]=t;this.route=c.path,this.hashRouting=c.hash,this.routerInstance=e,this.virtualEvent=n||{},this.originalEvent=a||{},this.path=l(o.pathname),this.hash=o.hash,this.search=l(o.search.substring(1)),this.hashSearch=l(o.hash&&o.hash.split("?")[1]);let{path:s}=c;this.hashRouting&&(s=`#${s}`,r&&(s=`${o.pathname}${s}`)),A.setDataToStore(s,this.originalEvent.state&&this.originalEvent.state.data),this.data=A.getDataFromStore(s)}}function M(){const{context:n,location:o,hashRouting:r}=this.config;var c;this.popStateSubscription=e(window,"popstate").subscribe(t=>{const e=l(r?o.hash.substring(1).split("?")[0]:o.pathname);e&&g(n,"vpushstate",[{path:e,hash:r},t])}),this.listeners=e(n,"vpushstate").pipe((c=this,e=>new t(t=>{const n=e.subscribe({next(e){t.next(new N(e.detail,c,e))},error(){t.error(...arguments)},complete(){t.complete()}});return()=>{n.unsubscribe()}}))),r&&!o.hash&&this.set("/",!0,!1)}function T(t){let e=[];return p(t)?(Object.keys(t).forEach(n=>{!function t(e,n,o){p(o)?Object.keys(o).forEach(r=>{t(e,`${n}[${u(o)?"":r}]`,o[r])}):"function"!=typeof o&&e.push(`${encodeURIComponent(n)}=${encodeURIComponent(o)}`)}(e,n,t[n])}),e.join("&")):"string"==typeof t?t:""}function B(t){return r.test(t)}function z(t=w.search,e=!1){"?"===(t=l(t)).charAt(0)&&(t=t.replace("?",""));const n={};return t&&t.split("&").forEach(t=>{const o=t.split("=").map(t=>decodeURIComponent(t));(B(o[0])?P:U).apply(this,[...o,n,e,!1])}),n}function D(t,e){return e?void 0===t?[]:t:(o={},u(n=t)&&n.forEach((t,e)=>{o[e]=t}),o);var n,o}function L(t,e){return f(t)?{ob:t}:u(t)||void 0===t?{ob:D(t,h(e))}:{ob:[t],push:null!==t}}function P(t,e,n,o=!0){const r=t.match(c)||[];if(3===r.length){const c=r[1];let i=r[2];if(B(t=t.replace(a,"")))""===i&&(i="0"),P(t=t.replace(s,i),e,n[c]=L(n[c],i).ob,o);else if(i){const t=L(n[c],i);n[c]=t.ob;const r=o?J(e):e;t.push?n[c].push({[i]:r}):n[c][i]=r}else U(c,e,n,o,!0)}}function U(t,e,n,o=!0,r){o&&(e=J(e)),t in n?(n[t]=u(n[t])?n[t]:[n[t]],n[t].push(e)):n[t]=r?[e]:e}function J(t){if(null==t)return"";if("string"!=typeof t)return t;if(h(t=l(t)))return+t;switch(t){case"null":return null;case"undefined":return;case"true":return!0;case"false":return!1;case"NaN":return NaN;default:return t}}function q(){return z.apply(this,arguments)}function F(t,e){const{location:n}=this.config,o=l(n.search&&n.search.substring(1)),r=l(e?n.hash.split("?")[1]:o);return r?T(v(q(o),q(r),q(t))):t}function K(t,e=!1,n=!0){const{preservePath:o,hashRouting:r,location:c,history:a}=this.config,s=v({replace:e,exec:n},"string"==typeof t?{route:t}:t);e=s.replace,n=s.exec;let{route:i,queryString:u}=s;const{preserveQuery:h,data:f,pageTitle:d=document.querySelector("head title").textContent}=s,x=i.split("?");if(p(u)&&(u=T(u)),u=l(u||x[1]),i=l(x[0]),h&&(u=F.apply(this,[u,r])),!_(i))throw new TypeError("Route string is not a pure route");{const t=i;r&&(i=`#${i}`,o&&(i=`${c.pathname}${i}`)),A.setDataToStore(i,f),i=`${i}${u?`?${u}`:""}`,a[e?"replaceState":"pushState"]({data:f},d,i),n&&t&&g(this.config.context,"vpushstate",[{path:t,hash:r}])}return this}function H(e,n){const{hashRouting:o,location:r}=e.config,c=l(o?r.hash.substring(1).split("?")[0]:r.pathname);return r=>new t(t=>{const a=r.subscribe({next(){t.next(...arguments)},error(){t.error(...arguments)},complete(){t.complete()}});return n||(n=!0,c&&t.next(new N([{path:c,hash:o}],e))),()=>{a.unsubscribe()}})}class Q{constructor(t={}){if(!window.history.pushState)throw new Error("Current browser does not support history object");t=v({hashRouting:!1,preservePath:!1,context:document.body,location:window.location,history:window.history},t),this.config=Object.freeze(t),this.__paths__=[],M.apply(this)}pipe(){return this.listeners.pipe(H(this),...arguments)}subscribe(){return this.listeners.pipe(H(this)).subscribe(...arguments)}set(){return K.apply(this,arguments)}destroy(t){"function"==typeof t&&t(),this.popStateSubscription.unsubscribe(),this.__paths__.length=0}}function V(t,e=w.pathname){const o={};if(n.test(t)){const r=new RegExp(t.replace(/\//g,"\\/").replace(/:[^/\\]+/g,"([^\\/]+)"));if(n.lastIndex=0,r.test(e)){const c=[...t.match(n)].map(t=>t.replace(":","")),a=[...e.match(r)];a.shift(),c.forEach((t,e)=>{o[t]=a[e]})}}return o}var G=Object.freeze({__proto__:null,route:function(e,n,o){if("boolean"==typeof n&&(o=n,n=void 0),e=l(e),n instanceof Q){const t=n.__paths__;-1===t.indexOf(e)&&t.push(e)}return r=>new t(t=>{const c=r.subscribe({next(n){let r=n.route;if(_(e)){o&&(e=e.toLowerCase(),r=r.toLowerCase());const c=V(e,r),a=Object.keys(c).length;(r===e||a>0)&&(a>0&&(n.params=c),t.next(n))}else t.error(new Error("Route string is not a pure route"))},error(){t.error(...arguments)},complete(){t.complete()}});return()=>{if(n instanceof Q){const t=n.__paths__,o=t.indexOf(e);o>-1&&t.splice(o,1)}c.unsubscribe()}})},deparam:function(e=!1){return n=>new t(t=>{const o=n.subscribe({next(n){try{n.search=q(n.search,e),n.hashSearch=q(n.hashSearch,e),t.next(n)}catch(e){t.error(e)}},error(){t.error(...arguments)},complete(){t.complete()}});return()=>{o.unsubscribe()}})},noMatch:function(e){return n=>new t(t=>{const o=n.subscribe({next(n){if(e instanceof Q){const o=e.__paths__;if(o.length>0){const e=n.route;let r=!1;for(let t=0;t<o.length;t++)if(o[t]===e||Object.keys(V(o[t],e)).length){r=!0;break}r&&(n.isErrorRoute=!0,t.next(n))}}},error(){t.error(...arguments)},complete(){t.complete()}});return()=>{o.unsubscribe()}})}});export{Q as Router,G as operators};
