import{Observable as t,fromEvent as e}from"rxjs";const n="popstate",o=/:[^/]+/g,r=/^\/(?=[^?]*)/,c="Current browser does not support history object",a="Route string is not a pure route",i=["localhost","0.0.0.0","127.0.0.1",null],s="vpushstate",u=Array.isArray;function l(t){return"string"==typeof t?t.trim():""}function h(t){return t=l(`${t}`),!(["null","undefined",""].indexOf(t)>-1)&&!isNaN(+t)}function p(t){return t&&"object"==typeof t}function f(t){return p(t)&&!u(t)}function _(t,e){return void 0===t?e:t}function d(t){return Array.prototype.slice.call(t)}function x(t){return"string"==typeof t&&r.test(t)}function b(t){return t?Object.keys(t):[]}function v(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function g(t,e){p(t)&&b(t).forEach((function(n){e[n]=t[n]}))}function w(){const t=p(arguments[0])?arguments[0]:{};for(let e=1;e<arguments.length;e++)g(arguments[e],t);return t}if(void 0===window.CustomEvent){const t=function(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};const n=document.createEvent("CustomEvent");return n.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),n};t.prototype=window.Event.prototype,window.CustomEvent=t}function y(t,e,n){t instanceof Node&&(t=[t]),function(t){return t instanceof NodeList||t instanceof HTMLCollection||Array.isArray(t)}(t)&&"string"==typeof e&&function(t,e){for(let n=0;n<t.length;n++)e(t[n],n)}(t,t=>{const o=new window.CustomEvent(e,{bubbles:!0,cancelable:!0,detail:n||[]});t.dispatchEvent(o)})}const m=window.location,S=String.fromCharCode;function C(t,e,n){t.context_data_position==e-1?(t.context_data_position=0,t.context_data.push(n(t.context_data_val)),t.context_data_val=0):t.context_data_position++}function E(t){t.context_enlargeIn--,0==t.context_enlargeIn&&(t.context_enlargeIn=2**t.context_numBits,t.context_numBits++)}function $(t,e,n){if(v(t.context_dictionaryToCreate,t.context_w)){if(t.context_w.charCodeAt(0)<256){for(let o=0;o<t.context_numBits;o++)t.context_data_val=t.context_data_val<<1,C(t,e,n);t.value=t.context_w.charCodeAt(0);for(let o=0;o<8;o++)t.context_data_val=t.context_data_val<<1|1&t.value,C(t,e,n),t.value=t.value>>1}else{t.value=1;for(let o=0;o<t.context_numBits;o++)t.context_data_val=t.context_data_val<<1|t.value,C(t,e,n),t.value=0;t.value=t.context_w.charCodeAt(0);for(let o=0;o<16;o++)t.context_data_val=t.context_data_val<<1|1&t.value,C(t,e,n),t.value=t.value>>1}E(t),delete t.context_dictionaryToCreate[t.context_w]}else{t.value=t.context_dictionary[t.context_w];for(let o=0;o<t.context_numBits;o++)t.context_data_val=t.context_data_val<<1|1&t.value,C(t,e,n),t.value=t.value>>1}E(t)}function O(t,e,n,o){let r=0,c=1;for(;c!==e;){const e=t.val&t.position;t.position>>=1,0===t.position&&(t.position=n,t.val=o(t.index++)),r|=(e>0?1:0)*c,c<<=1}return r}function I(t){return null==t?"":function(t,e,n){if(null==t)return"";const o={context_dictionary:{},context_dictionaryToCreate:{},context_data:[],context_c:"",context_wc:"",context_w:"",context_enlargeIn:2,context_dictSize:3,context_numBits:2,context_data_val:0,context_data_position:0};let r=0;for(let r=0;r<t.length;r+=1)o.context_c=t.charAt(r),v(o.context_dictionary,o.context_c)||(o.context_dictionary[o.context_c]=o.context_dictSize++,o.context_dictionaryToCreate[o.context_c]=!0),o.context_wc=o.context_w+o.context_c,v(o.context_dictionary,o.context_wc)?o.context_w=o.context_wc:($(o,e,n),o.context_dictionary[o.context_wc]=o.context_dictSize++,o.context_w=String(o.context_c));for(""!==o.context_w&&$(o,e,n),o.value=2,r=0;r<o.context_numBits;r++)o.context_data_val=o.context_data_val<<1|1&o.value,C(o,e,n),o.value=o.value>>1;for(;;){if(o.context_data_val=o.context_data_val<<1,o.context_data_position==e-1){o.context_data.push(n(o.context_data_val));break}o.context_data_position++}return o.context_data.join("")}(t,15,t=>S(t+32))+" "}function A(t){return null==t?"":""===t?null:function(t,e,n){const o=[],r={val:n(0),position:e,index:1},c=[];let a,i,s=4,u=4,l=3,h="";for(let t=0;t<3;t++)o[t]=t;switch(O(r,Math.pow(2,2),e,n)){case 0:i=S(O(r,Math.pow(2,8),e,n));break;case 1:i=S(O(r,Math.pow(2,16),e,n));break;case 2:return""}for(o[3]=i,a=i,c.push(i);;){if(r.index>t)return"";switch(i=O(r,Math.pow(2,l),e,n)){case 0:o[u++]=S(O(r,Math.pow(2,8),e,n)),i=u-1,s--;break;case 1:o[u++]=S(O(r,Math.pow(2,16),e,n)),i=u-1,s--;break;case 2:return c.join("")}if(0===s&&(s=Math.pow(2,l),l++),o[i])h=o[i];else{if(i!==u)return null;h=a+a.charAt(0)}c.push(h),o[u++]=a+h.charAt(0),s--,a=h,0===s&&(s=Math.pow(2,l),l++)}}(t.length,16384,e=>t.charCodeAt(e)-32)}function R(){try{return sessionStorage.setItem("testKey","testValue"),sessionStorage.removeItem("testKey"),!0}catch(t){return!1}}function j(t,e){return R()?sessionStorage.setItem(t,I(p(e)?JSON.stringify(e):e)):function(t,e){if(t&&void 0!==e){const n=m.hostname,o="https:"===m.protocol;let r=e;p(e)&&(r=JSON.stringify(e));const c="; path=/",a=-1===i.indexOf(n)?`; domain=${l(n)}`:"",s=o?"; secure":"";document.cookie=`${t} = ${r}${a}${c}${s}`}}(t,e)}function k(t){if(R()){let e=A(sessionStorage.getItem(t));try{return e=JSON.parse(e),e}catch(t){return e}}return function(t){if(t){const e=decodeURIComponent(document.cookie);let n="";return function(t,e){if(t&&t.length)for(let n=0;n<t.length;n+=1)if("function"==typeof e){const o=e.apply(t,[t[n],n]);if("boolean"==typeof o){if(o)continue;break}}}(e.split(";"),e=>{const o=`${t}=`,r=e.indexOf(o);if(r>-1)return n=l(e.substring(r+o.length,e.length)),!1}),n}return""}(t)}const N={set(){return j.apply(this,arguments)},get(){return k.apply(this,arguments)}};const M=new class{getDataFromStore(t){return w(N.get("routeStore"))[t]}setDataToStore(t,e){let n=w(N.get("routeStore"));if(n[t]&&(!e||f(e)&&0===b(e).length))return!1;const o={};return o[t]=e,n=w({},n,o),N.set("routeStore",n)}};class T{constructor(t,e,n){const{location:o,preservePath:r}=e.config,[c,a]=t;this.route=c.path,this.hashRouting=c.hash,this.routerInstance=e,this.virtualEvent=n||{},this.originalEvent=a||{},this.path=l(o.pathname),this.hash=o.hash,this.search=l(o.search.substring(1)),this.hashSearch=l(o.hash&&o.hash.split("?")[1]);let{path:i}=c;this.hashRouting&&(i=`#${i}`,r&&(i=`${o.pathname}${i}`)),M.setDataToStore(i,this.originalEvent.state&&this.originalEvent.state.data),this.data=M.getDataFromStore(i)}}function B(){const{context:o,location:r,hashRouting:c}=this.config;var a;this.popStateSubscription=e(window,n).subscribe(t=>{const e=l(c?r.hash.substring(1).split("?")[0]:r.pathname);e&&y(o,s,[{path:e,hash:c},t])}),this.listeners=e(o,s).pipe((a=this,e=>new t(t=>{const n=e.subscribe({next(e){t.next(new T(e.detail,a,e))},error(){t.error(...arguments)},complete(){t.complete()}});return()=>{n.unsubscribe()}}))),c&&!r.hash&&this.set("/",!0,!1)}function z(t){let e=[];return p(t)?(b(t).forEach(n=>{!function t(e,n,o){p(o)?b(o).forEach(r=>{t(e,`${n}[${u(o)?"":r}]`,o[r])}):"function"!=typeof o&&e.push(`${encodeURIComponent(n)}=${encodeURIComponent(o)}`)}(e,n,t[n])}),e.join("&")):"string"==typeof t?t:""}function D(t){return/\[/.test(t)}function L(t,e){"?"===(t=l(_(t,m.search))).charAt(0)&&(t=t.replace("?",""));const n={};return t&&t.split("&").forEach(t=>{const o=t.split("=").map(t=>decodeURIComponent(t));(D(o[0])?J:q).apply(this,[].concat(o,[n,_(e,!1),!1]))}),n}function P(t,e){return e?void 0===t?[]:t:(o={},u(n=t)&&n.forEach((t,e)=>{o[e]=t}),o);var n,o}function U(t,e){return f(t)?{ob:t}:u(t)||void 0===t?{ob:P(t,h(e))}:{ob:[t],push:null!==t}}function J(t,e,n,o){o=_(o,!0);const r=t.match(/([^[]+)\[([^[]*)\]/)||[];if(3===r.length){const c=r[1];let a=r[2];if(D(t=t.replace(/\[([^[]*)\]/,"")))""===a&&(a="0"),J(t=t.replace(/[^[]+/,a),e,n[c]=U(n[c],a).ob,o);else if(a){const t=U(n[c],a);n[c]=t.ob;const r=o?F(e):e;if(t.push){const t={};t[a]=r,n[c].push(t)}else n[c][a]=r}else q(c,e,n,o,!0)}}function q(t,e,n,o,r){_(o,!0)&&(e=F(e)),t in n?(n[t]=u(n[t])?n[t]:[n[t]],n[t].push(e)):n[t]=r?[e]:e}function F(t){if(null==t)return"";if("string"!=typeof t)return t;if(h(t=l(t)))return+t;switch(t){case"null":return null;case"undefined":return;case"true":return!0;case"false":return!1;case"NaN":return NaN;default:return t}}function K(){return L.apply(this,arguments)}function H(t,e){const{location:n}=this.config,o=l(n.search&&n.search.substring(1)),r=l(e?n.hash.split("?")[1]:o);return r?z(w(K(o),K(r),K(t))):t}function Q(t,e=!1,n=!0){const{preservePath:o,hashRouting:r,location:c,history:i}=this.config,u=w({replace:e,exec:n},"string"==typeof t?{route:t}:t);e=u.replace,n=u.exec;let{route:h,queryString:f}=u;const{preserveQuery:_,data:d,pageTitle:b=document.querySelector("head title").textContent}=u,v=h.split("?");if(p(f)&&(f=z(f)),f=l(f||v[1]),h=l(v[0]),_&&(f=H.apply(this,[f,r])),!x(h))throw new TypeError(a);{const t=h;r&&(h=`#${h}`,o&&(h=`${c.pathname}${h}`)),M.setDataToStore(h,d),h=`${h}${f?`?${f}`:""}`,i[e?"replaceState":"pushState"]({data:d},b,h),n&&t&&y(this.config.context,s,[{path:t,hash:r}])}return this}function V(e,n){const{hashRouting:o,location:r}=e.config,c=l(o?r.hash.substring(1).split("?")[0]:r.pathname);return r=>new t(t=>{const a=r.subscribe({next(){t.next(...arguments)},error(){t.error(...arguments)},complete(){t.complete()}});return n||(n=!0,c&&t.next(new T([{path:c,hash:o}],e))),()=>{a.unsubscribe()}})}class G{constructor(t={}){if(!window.history.pushState)throw new Error(c);t=w({hashRouting:!1,preservePath:!1,context:document.body,location:window.location,history:window.history},t),this.config=Object.freeze(t),this.__paths__=[],B.apply(this)}pipe(){return this.listeners.pipe(V(this),...arguments)}subscribe(){return this.listeners.pipe(V(this)).subscribe(...arguments)}set(){return Q.apply(this,arguments)}destroy(t){"function"==typeof t&&t(),this.popStateSubscription.unsubscribe(),this.__paths__.length=0}}function W(t,e){e=_(e,m.pathname);const n={};if(o.test(t)){const r=new RegExp(t.replace(/\//g,"\\/").replace(/:[^/\\]+/g,"([^\\/]+)"));if(o.lastIndex=0,r.test(e)){const c=d(t.match(o)).map(t=>t.replace(":","")),a=d(e.match(r));a.shift(),c.forEach((t,e)=>{n[t]=a[e]})}}return n}var X=Object.freeze({__proto__:null,route:function(e,n,o){if("boolean"==typeof n&&(o=n,n=void 0),e=l(e),n instanceof G){const t=n.__paths__;-1===t.indexOf(e)&&t.push(e)}return r=>new t(t=>{const c=r.subscribe({next(n){let r=n.route;if(x(e)){o&&(e=e.toLowerCase(),r=r.toLowerCase());const c=W(e,r),a=Object.keys(c).length;(r===e||a>0)&&(a>0&&(n.params=c),t.next(n))}else t.error(new Error(a))},error(){t.error(...arguments)},complete(){t.complete()}});return()=>{if(n instanceof G){const t=n.__paths__,o=t.indexOf(e);o>-1&&t.splice(o,1)}c.unsubscribe()}})},deparam:function(e=!1){return n=>new t(t=>{const o=n.subscribe({next(n){try{n.search=K(n.search,e),n.hashSearch=K(n.hashSearch,e),t.next(n)}catch(e){t.error(e)}},error(){t.error(...arguments)},complete(){t.complete()}});return()=>{o.unsubscribe()}})},noMatch:function(e){return n=>new t(t=>{const o=n.subscribe({next(n){if(e instanceof G){const o=e.__paths__;if(o.length>0){const e=n.route;let r=!1;for(let t=0;t<o.length;t++)if(o[t]===e||Object.keys(W(o[t],e)).length){r=!0;break}r&&(n.isErrorRoute=!0,t.next(n))}}},error(){t.error(...arguments)},complete(){t.complete()}});return()=>{o.unsubscribe()}})}});export{G as Router,X as operators};
